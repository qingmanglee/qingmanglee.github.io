<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>轻芒的博客</title>
  <subtitle>爱编程、爱分享</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://yoursite.com/"/>
  <updated>2017-10-26T12:45:05.000Z</updated>
  <id>http://yoursite.com/</id>
  
  <author>
    <name>轻芒</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>zookeeper伪分布式集群搭建</title>
    <link href="http://yoursite.com/2017/10/26/zookeeper%E4%BC%AA%E5%88%86%E5%B8%83%E5%BC%8F%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA/"/>
    <id>http://yoursite.com/2017/10/26/zookeeper伪分布式集群搭建/</id>
    <published>2017-10-26T11:32:09.000Z</published>
    <updated>2017-10-26T12:45:05.000Z</updated>
    
    <content type="html"><![CDATA[<p>###前言<br><a href="https://zh.wikipedia.org/wiki/Apache_ZooKeeper" target="_blank" rel="external">ZooKeeper</a>是一个分布式的，开放源码的分布式应用程序协调服务，<a href="https://zookeeper.apache.org/" target="_blank" rel="external">参见官网</a>。典型应用场景，如目录服务、配置管理、同步、集群节点选举、消息队列、通知系统等。本文演示搭建一个单机三个实例的伪分布集群。</p>
<p>###准备<br>下载并解压zookeeper。创建三个目录，分别为这三个实例的目录环境，并在三个目录中创建内容分别为1，2，3的名称为myid文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$tree zoo1/ zoo2/ zoo3</div><div class="line">zoo1/</div><div class="line">└── myid</div><div class="line">zoo2/</div><div class="line">└── myid</div><div class="line">zoo3</div><div class="line">└── myid</div></pre></td></tr></table></figure>
<p>###配置<br>在zookeeper的配置目录下，分别创建三个名为zoo1.cfg、zoo2.cfg、zoo3.cfg的配置文件。<br>以server.1=10.101.80.35:9110:9210为例，1为对应实例myid内容编号，10.101.80.35为ip，9110为Leader选举的端口，9210为zookeeper实例之间通信的端口，因搭建的伪分布式集群，所以端口各不相同，真实的分布式集群，三个实例的端口通常相同。</p>
<p>内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">zoo1.cfg</div><div class="line"></div><div class="line">tickTime=2000</div><div class="line">initLimit=10</div><div class="line">syncLimit=5</div><div class="line">dataDir=/home/admin/zookeeper/zoo1</div><div class="line">clientPort=2181</div><div class="line">server.1=10.101.80.35:9110:9210</div><div class="line">server.2=10.101.80.35:9111:9211</div><div class="line">server.3=10.101.80.35:9112:9212</div><div class="line"></div><div class="line">zoo2.cfg</div><div class="line"></div><div class="line">tickTime=2000</div><div class="line">initLimit=10</div><div class="line">syncLimit=5</div><div class="line">dataDir=/home/admin/zookeeper/zoo2</div><div class="line">clientPort=2181</div><div class="line">server.1=10.101.80.35:9110:9210</div><div class="line">server.2=10.101.80.35:9111:9211</div><div class="line">server.3=10.101.80.35:9112:9212</div><div class="line"></div><div class="line">zoo3.cfg</div><div class="line"></div><div class="line">tickTime=2000</div><div class="line">initLimit=10</div><div class="line">syncLimit=5</div><div class="line">dataDir=/home/admin/zookeeper/zoo3</div><div class="line">clientPort=2181</div><div class="line">server.1=10.101.80.35:9110:9210</div><div class="line">server.2=10.101.80.35:9111:9211</div><div class="line">server.3=10.101.80.35:9112:9212</div></pre></td></tr></table></figure>
<p>###启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">cd  /home/admin/zookeeper/zookeeper-3.4.10</div><div class="line"></div><div class="line">./bin/zkServer.sh  start ./conf/zoo1.cfg</div><div class="line">./bin/zkServer.sh  start ./conf/zoo2.cfg</div><div class="line">./bin/zkServer.sh  start ./conf/zoo3.cfg</div><div class="line"></div><div class="line">#查看状态</div><div class="line">$./bin/zkServer.sh  status ./conf/zoo1.cfg</div><div class="line">ZooKeeper JMX enabled by default</div><div class="line">Using config: ./conf/zoo1.cfg</div><div class="line">Mode: follower</div></pre></td></tr></table></figure>
<p>###命令行操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">#进入集群</div><div class="line">./bin/zkCli.sh -server 10.101.80.35:2182</div><div class="line"></div><div class="line">#创建节点</div><div class="line">[zk: 10.101.80.35:2182(CONNECTED) 3] create /mynode test</div><div class="line">Created /mynode</div><div class="line">[zk: 10.101.80.35:2182(CONNECTED) 4] ls /</div><div class="line">[mynode, zookeeper]</div><div class="line"></div><div class="line">#查看所有节点</div><div class="line">[zk: 10.101.80.35:2182(CONNECTED) 7] ls /</div><div class="line">[mynode, zookeeper]</div><div class="line"></div><div class="line">#查看指定节点</div><div class="line">[zk: 10.101.80.35:2182(CONNECTED) 5] get /mynode</div><div class="line">test</div><div class="line">cZxid = 0x100000004</div><div class="line">ctime = Thu Oct 26 20:38:29 CST 2017</div><div class="line">mZxid = 0x100000004</div><div class="line">mtime = Thu Oct 26 20:38:29 CST 2017</div><div class="line">pZxid = 0x100000004</div><div class="line">cversion = 0</div><div class="line">dataVersion = 0</div><div class="line">aclVersion = 0</div><div class="line">ephemeralOwner = 0x0</div><div class="line">dataLength = 4</div><div class="line">numChildren = 0</div><div class="line"></div><div class="line">#更新节点内容</div><div class="line">[zk: 10.101.80.35:2182(CONNECTED) 8] set /mynode haha</div><div class="line">cZxid = 0x100000004</div><div class="line">ctime = Thu Oct 26 20:38:29 CST 2017</div><div class="line">mZxid = 0x100000005</div><div class="line">mtime = Thu Oct 26 20:43:40 CST 2017</div><div class="line">pZxid = 0x100000004</div><div class="line">cversion = 0</div><div class="line">dataVersion = 1</div><div class="line">aclVersion = 0</div><div class="line">ephemeralOwner = 0x0</div><div class="line">dataLength = 4</div><div class="line">numChildren = 0</div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;###前言&lt;br&gt;&lt;a href=&quot;https://zh.wikipedia.org/wiki/Apache_ZooKeeper&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;ZooKeeper&lt;/a&gt;是一个分布式的，开放源码的分布式应用程序协调服务，&lt;a
    
    </summary>
    
      <category term="zookeeper" scheme="http://yoursite.com/categories/zookeeper/"/>
    
    
      <category term="zookeeper" scheme="http://yoursite.com/tags/zookeeper/"/>
    
      <category term="分布式" scheme="http://yoursite.com/tags/%E5%88%86%E5%B8%83%E5%BC%8F/"/>
    
  </entry>
  
  <entry>
    <title>yii2 php多进程 出现 MySQL server has gone away</title>
    <link href="http://yoursite.com/2017/08/09/yii2-php%E5%A4%9A%E8%BF%9B%E7%A8%8B-%E5%87%BA%E7%8E%B0-MySQL-server-has-gone-away/"/>
    <id>http://yoursite.com/2017/08/09/yii2-php多进程-出现-MySQL-server-has-gone-away/</id>
    <published>2017-08-09T06:47:40.000Z</published>
    <updated>2017-10-26T11:08:02.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="问题-amp-场景"><a href="#问题-amp-场景" class="headerlink" title="问题&amp;场景"></a>问题&amp;场景</h3><p>在yii2的command，利用多进程消费数据库中的数据时，总是出现gone away。</p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>在mysql的官方文档中其实有专门的章节说明这个问题，原因也是各种各样，<a href="https://dev.mysql.com/doc/refman/5.7/en/gone-away.html" target="_blank" rel="external">详见</a>；<br>其中有一条刚好符合我的场景，大意就是，当fork的子进程都共用相同的mysql连接的时候，会出现该错误，每个子进程单独一个mysql连接即可解决。</p>
<blockquote>
<p>You can also encounter this error with applications that fork child processes, all of which try to use the same connection to the MySQL server. This can be avoided by using a separate connection for each child process.</p>
</blockquote>
<h3 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h3><p>在子进程执行之前，先把mysql的连接close即可。</p>
<h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> ($i = <span class="number">0</span>; $i &lt; $processNum; $i++) &#123;</div><div class="line">    $pid = pcntl_fork();</div><div class="line">    <span class="keyword">if</span>(!$pid)&#123; <span class="comment">// 子进程处理</span></div><div class="line">        Yii::$app-&gt;db-&gt;close();<span class="comment">// solve 子进程 MySQL server has gone away</span></div><div class="line">        <span class="keyword">$this</span>-&gt;_work($tasks[$i]);</div><div class="line">        <span class="keyword">exit</span>(<span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">Yii::$app-&gt;db-&gt;close();<span class="comment">// solve 主进程 MySQL server has gone away</span></div><div class="line"></div><div class="line">$status = <span class="keyword">null</span>;</div><div class="line"><span class="keyword">while</span>(pcntl_waitpid(<span class="number">0</span>, $status, WUNTRACED) != <span class="number">-1</span>)&#123;</div><div class="line">    pcntl_wexitstatus($status);</div><div class="line">    CommonLog::saveLog(<span class="string">'子进程结束'</span>.<span class="string">"\n"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;问题-amp-场景&quot;&gt;&lt;a href=&quot;#问题-amp-场景&quot; class=&quot;headerlink&quot; title=&quot;问题&amp;amp;场景&quot;&gt;&lt;/a&gt;问题&amp;amp;场景&lt;/h3&gt;&lt;p&gt;在yii2的command，利用多进程消费数据库中的数据时，总是出现gone awa
    
    </summary>
    
      <category term="php" scheme="http://yoursite.com/categories/php/"/>
    
    
      <category term="php" scheme="http://yoursite.com/tags/php/"/>
    
      <category term="yii2" scheme="http://yoursite.com/tags/yii2/"/>
    
      <category term="多进程" scheme="http://yoursite.com/tags/%E5%A4%9A%E8%BF%9B%E7%A8%8B/"/>
    
      <category term="mysql" scheme="http://yoursite.com/tags/mysql/"/>
    
  </entry>
  
</feed>
